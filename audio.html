<html>
  <head>
    <script src="assets/js/jquery.min.js"></script>
    <script src="https://unpkg.com/wavesurfer.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/1.4.0/wavesurfer.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/1.2.3/plugin/wavesurfer.regions.min.js"></script>
    </head>
  <body>
    <audio id="audio"></audio>
    <input type="file" id="avatar1" name="avatar" accept=" audio/mp3" onchange="checkFileDuration(this.id, 'how')">
    <input type="file" id="avatar2" name="avatar" accept=" audio/mp3" onchange="checkFileDuration(this.id, 'what')">
    <div id="ciao">
      <input type="file" id="why" name="avatar" accept=" audio/mp3" onchange="checkFileDuration(this.id, 'why')">
    </div>
    <button onclick="why()">
        Add new Why
    </button>
      <div id="waveform"></div>

      <script>
        function carica(data){
          var wavesurfer,etime,stime;
            wavesurfer = WaveSurfer.create({
              container: '#waveform',
              scrollParent : false,
              responsive : true,
              height: 128,
              normalize: false,
              waveColor: '#33FF99',
              progressColor: '#33FF99',
              audioRate: 1,
              cursorColor: 'blue',
              cursorWidth: 2,
              backend: 'MediaElement',
              mediaType: 'audio',
              render: 'Canvas',
              interact: true,
              hideScrollbar: true
            });
            wavesurfer.on('ready', function () {
              stime = 0
              etime = wavesurfer.getDuration()
              wavesurfer.addRegion({
                start: 0,
                end: etime,
                color: 'hsl(204, 85%, 82%)',
                resize:true,
                drag:true
              });
            });
            wavesurfer.on('region-update-end', function (region) {
              stime = region.start;
              etime = region.end;
            });

              wavesurfer.on("seek", function(){
              wavesurfer.play();

            });
            var url = URL.createObjectURL(data);
            wavesurfer.load(url); // load audio
        }

        function checkFileDuration(id, tipo) {
              var file = document.querySelector('#'+id).files[0];
              var reader = new FileReader();
              var fileSize = file.size;
              console.log(file.type)
              reader.onload = function(e) {
                if (file.type == "audio/mp3" || file.type == "audio/wav" || file.type == "audio/ogg") {
                    var audioElement = document.createElement('audio');
                    audioElement.src = e.target.result;
                    var timer = setInterval(function() {
                      console.log(audioElement)
                      if (audioElement.readyState === 4) {
                        switch (tipo) {
                            case "why":
                            console.log("whyyyyy")
                            if(audioElement.duration > 15){
                              //TODO UPLOAD NEW AUDIO
                               $('#'+id).val("");
                            }else{
                              //TODO OK AUDIO
                            };break;
                            case "how":
                            console.log("howwwww")
                            carica(file);
                            if(audioElement.duration > 30 && audioElement.duration < 15){
                              //TODO UPLOAD NEW AUDIO
                            //  $('#'+id).val("");
                            }else{
                              //TODO OK AUDIO
                            };break;
                            case "what":
                            console.log("whaaattttt")
                            if(audioElement.duration > 15){
                              //TODO UPLOAD NEW AUDIO
                              $('#'+id).val("");
                            }else{
                              //TODO OK AUDIO
                            };break;
                          default:
                            console.log("Bah, qualcosa Ã¨ andato storto, mi disp")
                        }

                        clearInterval(timer);
                      }
                    }, 500);
                  }
                };
                if (file) {
                  reader.readAsDataURL(file);
                } else {
                  alert('nofile');
                }
              }

              function why(){
                var c ='"why"'
                $("#ciao").append("<input type='file' id='why"+$("#ciao").children().length+"' name='avatar' accept='audio/mp3' onchange='checkFileDuration(this.id, "+c+")'>")
              }
      </script>

  </body>
</html>
