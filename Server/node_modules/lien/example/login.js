"use strict";

// Dependencies
var Lien = require("../lib");

var users = {
    Alice: "123",
    Bob: "1234"
};

// Init lien app
var app = new Lien({
    host: "localhost",
    port: 9000,
    public: __dirname + "/public",
    session: {
        store: "connect-mongo",
        storeOptions: {
            url: "mongodb://localhost/test-app"
        }
    }
});

// Listen for load
app.on("load", function (err) {
    console.log(err || "App started on port 9000.");
    err && process.exit(1);
});

// Add page
app.all("/", function (lien) {
    if (lien.getSessionData("logged_in")) {
        lien.file("logout.html");
    } else {
        lien.file("login.html");
    }
});

app.post("/api/login", function (lien) {
    if (!lien.data.username || !lien.data.password) {
        return lien.apiError("Incomplete data.");
    }

    if (lien.getSessionData("logged_in")) {
        return lien.redirect("/");
    }

    if (users[lien.data.username] === lien.data.password) {
        lien.startSession({
            logged_in: true,
            authenticated_at: new Date(),
            username: lien.data.username
        });
        return lien.redirect("/");
    }

    lien.apiError("Invalid credentials.", 403);
});

app.get("/api/session", function (lien) {
    lien.end(lien.getSessionData());
});

app.post("/api/logout", function (lien) {
    if (!lien.getSessionData("logged_in")) {
        return lien.apiError("You were not logged in anyways.");
    }

    lien.destroySession();
    lien.redirect("/");
});

// Add a dynamic route
app.get("/post/:id", function (lien) {
    lien.end("Post id: " + lien.params.id);
});

app.use("/auth", function (lien, next) {
    var username = lien.getSessionData("username");
    lien.user = username ? {
        name: username
    } : null;
    if (!lien.user) {
        return lien.status(403).json({
            error: "Unauthorized"
        });
    }
    next();
});

app.get("/auth", function (lien) {
    lien.end({
        user: "/auth/user"
    });
});

app.get("/auth/user", function (lien) {
    lien.end({
        foo: "Bar",
        user: lien.user
    });
});

app.get("/test", "/index.html");

app.on("serverError", function (err) {
    console.log(err.stack);
});